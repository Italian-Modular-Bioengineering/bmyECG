Amat = @(X11, X21, X41, a11, a21, a31, a41, b11, b21, b31, b41, th011, th021, th031, th041) [0, -X41, 0, -X21; X41, 0, 0, X11; X21 .* a11 .* exp(-(-th011 + atan2 (X21, X11)) .^ 2 ./ (2 * b11 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) - X21 .* a11 .* (-th011 + atan2(X21, X11)) .^ 2 .* exp(-(-th011 + atan2 (X21, X11)) .^ 2 ./ (2 * b11 .^ 2)) ./ (b11 .^ 2 .* (X11 .^ 2 + X21 .^ 2)) + X21 .* a21 .* exp(-(-th021 + atan2 (X21, X11)) .^ 2 ./ (2 * b21 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) - X21 .* a21 .* (-th021 + atan2(X21, X11)) .^ 2 .* exp(-(-th021 + atan2 (X21, X11)) .^ 2 ./ (2 * b21 .^ 2)) ./ (b21 .^ 2 .* (X11 .^ 2 + X21 .^ 2)) + X21 .* a31 .* exp(-(-th031 + atan2 (X21, X11)) .^ 2 ./ (2 * b31 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) - X21 .* a31 .* (-th031 + atan2(X21, X11)) .^ 2 .* exp(-(-th031 + atan2 (X21, X11)) .^ 2 ./ (2 * b31 .^ 2)) ./ (b31 .^ 2 .* (X11 .^ 2 + X21 .^ 2)) + X21 .* a41 .* exp(-(-th041 + atan2 (X21, X11)) .^ 2 ./ (2 * b41 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) - X21 .* a41 .* (-th041 + atan2(X21, X11)) .^ 2 .* exp(-(-th041 + atan2 (X21, X11)) .^ 2 ./ (2 * b41 .^ 2)) ./ (b41 .^ 2 .* (X11 .^ 2 + X21 .^ 2)), -X11 .* a11 .* exp(-(-th011 + atan2 (X21, X11)) .^ 2 ./ (2 * b11 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) + X11 .* a11 .* (-th011 + atan2(X21, X11)) .^ 2 .* exp(-(-th011 + atan2 (X21, X11)) .^ 2 ./ (2 * b11 .^ 2)) ./ (b11 .^ 2 .* (X11 .^ 2 + X21 .^ 2)) - X11 .* a21 .* exp(-(-th021 + atan2 (X21, X11)) .^ 2 ./ (2 * b21 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) + X11 .* a21 .* (-th021 + atan2(X21, X11)) .^ 2 .* exp(-(-th021 + atan2 (X21, X11)) .^ 2 ./ (2 * b21 .^ 2)) ./ (b21 .^ 2 .* (X11 .^ 2 + X21 .^ 2)) - X11 .* a31 .* exp(-(-th031 + atan2 (X21, X11)) .^ 2 ./ (2 * b31 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) + X11 .* a31 .* (-th031 + atan2(X21, X11)) .^ 2 .* exp(-(-th031 + atan2 (X21, X11)) .^ 2 ./ (2 * b31 .^ 2)) ./ (b31 .^ 2 .* (X11 .^ 2 + X21 .^ 2)) - X11 .* a41 .* exp(-(-th041 + atan2 (X21, X11)) .^ 2 ./ (2 * b41 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) + X11 .* a41 .* (-th041 + atan2(X21, X11)) .^ 2 .* exp(-(-th041 + atan2 (X21, X11)) .^ 2 ./ (2 * b41 .^ 2)) ./ (b41 .^ 2 .* (X11 .^ 2 + X21 .^ 2)), -1, 0; 0, 0, 0, 0];



A = @(X,a,b,th) Amat(X(1), X(2), X(4), a(1), a(2), a(3), a(4), b(1), b(2), b(3), b(4), th(1), th(2), th(3), th(4));


