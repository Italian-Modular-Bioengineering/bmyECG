clear all;

syms z0 T
X = sym('X', [4,1]);
a = sym('a', [4,1]);
b = sym('b', [4,1]);
th0 = sym('th0', [4,1]);
th = atan2(X(2), X(1));

dth = th - th0;

Xdot = [ -X(4)*X(2);
           X(4)*X(1);
          -sum(a.*dth.*exp(-dth.^2./(2*b.^2))) - (X(3) - z0);
         0 ];
         
A0 = (jacobian(Xdot,X));
Amat = matlabFunction(A0);

theta = atan2(X(2), X(1));
dth = theta - th0;
csi = exp(-dth.^2./(2*b.^2));
m2 = X(1)^2 + X(2)^2;
sdth1 = -X(2)/m2;
sdth2 = X(1)/m2;
pf = (dth./b).^2 - 1;
X3dX1 = sum(a.*csi.*sdth1.*pf);
X3dX2 = sum(a.*csi.*sdth2.*pf);

##
##A0 = @(X11, X21, X41, a11, a21, a31, a41, b11, b21, b31, b41, th011, th021, th031, th041) [0, -X41, 0, -X21; X41, 0, 0, X11; X21 .* a11 .* exp(-(-th011 + atan2 (X21, X11)) .^ 2 ./ (2 * b11 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) - X21 .* a11 .* (-th011 + atan2(X21, X11)) .^ 2 .* exp(-(-th011 + atan2 (X21, X11)) .^ 2 ./ (2 * b11 .^ 2)) ./ (b11 .^ 2 .* (X11 .^ 2 + X21 .^ 2)) + X21 .* a21 .* exp(-(-th021 + atan2 (X21, X11)) .^ 2 ./ (2 * b21 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) - X21 .* a21 .* (-th021 + atan2(X21, X11)) .^ 2 .* exp(-(-th021 + atan2 (X21, X11)) .^ 2 ./ (2 * b21 .^ 2)) ./ (b21 .^ 2 .* (X11 .^ 2 + X21 .^ 2)) + X21 .* a31 .* exp(-(-th031 + atan2 (X21, X11)) .^ 2 ./ (2 * b31 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) - X21 .* a31 .* (-th031 + atan2(X21, X11)) .^ 2 .* exp(-(-th031 + atan2 (X21, X11)) .^ 2 ./ (2 * b31 .^ 2)) ./ (b31 .^ 2 .* (X11 .^ 2 + X21 .^ 2)) + X21 .* a41 .* exp(-(-th041 + atan2 (X21, X11)) .^ 2 ./ (2 * b41 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) - X21 .* a41 .* (-th041 + atan2(X21, X11)) .^ 2 .* exp(-(-th041 + atan2 (X21, X11)) .^ 2 ./ (2 * b41 .^ 2)) ./ (b41 .^ 2 .* (X11 .^ 2 + X21 .^ 2)), -X11 .* a11 .* exp(-(-th011 + atan2 (X21, X11)) .^ 2 ./ (2 * b11 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) + X11 .* a11 .* (-th011 + atan2(X21, X11)) .^ 2 .* exp(-(-th011 + atan2 (X21, X11)) .^ 2 ./ (2 * b11 .^ 2)) ./ (b11 .^ 2 .* (X11 .^ 2 + X21 .^ 2)) - X11 .* a21 .* exp(-(-th021 + atan2 (X21, X11)) .^ 2 ./ (2 * b21 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) + X11 .* a21 .* (-th021 + atan2(X21, X11)) .^ 2 .* exp(-(-th021 + atan2 (X21, X11)) .^ 2 ./ (2 * b21 .^ 2)) ./ (b21 .^ 2 .* (X11 .^ 2 + X21 .^ 2)) - X11 .* a31 .* exp(-(-th031 + atan2 (X21, X11)) .^ 2 ./ (2 * b31 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) + X11 .* a31 .* (-th031 + atan2(X21, X11)) .^ 2 .* exp(-(-th031 + atan2 (X21, X11)) .^ 2 ./ (2 * b31 .^ 2)) ./ (b31 .^ 2 .* (X11 .^ 2 + X21 .^ 2)) - X11 .* a41 .* exp(-(-th041 + atan2 (X21, X11)) .^ 2 ./ (2 * b41 .^ 2)) ./ (X11 .^ 2 + X21 .^ 2) + X11 .* a41 .* (-th041 + atan2(X21, X11)) .^ 2 .* exp(-(-th041 + atan2 (X21, X11)) .^ 2 ./ (2 * b41 .^ 2)) ./ (b41 .^ 2 .* (X11 .^ 2 + X21 .^ 2)), -1, 0; 0, 0, 0, 0];
##
##A = @(X,a,b,th) A0(X(1), X(2), X(4), a(1), a(2), a(3), a(4), b(1), b(2), b(3), b(4), th(1), th(2), th(3), th(4));
##
##

X0 = rand(4,1); 
th0n = [ -pi/3 -pi/12 0 pi/12 pi/2 ]';
an = [ 1.2 -5 30 -7.5 0.75 ]';
bn = [ 0.25 0.1 0.1 0.1 0.4 ]';

An0=(simplify(subs(A0, {X(1),X(2), X(3), X(4), a(1), a(2), a(3), a(4), b(1), b(2), b(3), b(4),th0(1), th0(2), th0(3), th0(4)},...
         {X0(1),X0(2), X0(3), X0(4), an(1), an(2), an(3), an(4), bn(1), bn(2), bn(3), bn(4),th0n(1), th0n(2), th0n(3), th0n(4)})));
         
X3dX1n = (simplify(subs(X3dX1, {X(1),X(2), X(3), X(4), a(1), a(2), a(3), a(4), b(1), b(2), b(3), b(4),th0(1), th0(2), th0(3), th0(4)},...
         {X0(1),X0(2), X0(3), X0(4), an(1), an(2), an(3), an(4), bn(1), bn(2), bn(3), bn(4),th0n(1), th0n(2), th0n(3), th0n(4)})));

X3dX2n = (simplify(subs(X3dX2, {X(1),X(2), X(3), X(4), a(1), a(2), a(3), a(4), b(1), b(2), b(3), b(4),th0(1), th0(2), th0(3), th0(4)},...
         {X0(1),X0(2), X0(3), X0(4), an(1), an(2), an(3), an(4), bn(1), bn(2), bn(3), bn(4),th0n(1), th0n(2), th0n(3), th0n(4)})));

